# MOD 删除功能说明

## 功能概述

为 SPT 自动安装器新增了 **MOD 删除**功能，允许用户安全地卸载已安装的 MOD。该功能基于**安装日志**方案实现，通过标记文件精确追踪每个 MOD 的文件，确保删除的准确性和安全性。

## 核心设计

### 1. 标记文件扩展

在现有的 `.spt_installed.json` 标记文件中新增 `mods` 字段，用于记录已安装的 MOD 及其文件列表：

```json
{
  "version": "4.0.5",
  "server_zip": "SPT-4.0.5-40087-1bba508.zip",
  "client_zip": "Client.0.16.9.0.40087.zip",
  "installed_at": "2025-11-24T13:00:00",
  "mods": {
    "ExampleMod": {
      "files": [
        "Mods/mod1/file1.txt",
        "Mods/mod1/subdir/file2.dat",
        "Config/mod1_config.ini"
      ],
      "installed_at": "2025-11-24T13:05:00"
    },
    "AnotherMod": {
      "files": [
        "Plugins/plugin.dll",
        "Config/plugin.ini"
      ],
      "installed_at": "2025-11-24T13:10:00"
    }
  }
}
```

### 2. 工作流程

#### 安装 MOD 时
1. 用户在菜单中选择"安装内置 MOD"
2. 系统解压 MOD 压缩包到游戏目录
3. **自动记录**解压的所有文件到标记文件的 `mods` 字段
4. 显示安装完成提示

#### 删除 MOD 时
1. 用户在菜单中选择"删除已安装的 MOD"
2. 系统读取标记文件，显示已安装的 MOD 列表（包括文件数量）
3. 用户选择要删除的 MOD
4. 系统二次确认（显示将删除的文件数量）
5. 逐个删除记录中的文件
6. 从标记文件中删除该 MOD 的记录
7. 显示删除结果（已删除/跳过的文件数量）

## 实现细节

### 修改的文件

#### 1. `scripts/utils.py`
- **修改 `extract_zip()` 函数**：现在返回解压的文件列表（相对路径）
- 返回值类型：`List[str]`
- 记录的是**非目录文件**的相对路径

#### 2. `scripts/installers.py`
新增辅助函数：
- `_record_mod_installation(target_root, mod_name, files)` - 记录 MOD 安装的文件
- `_get_mod_files(target_root, mod_name)` - 获取已安装 MOD 的文件列表
- `_remove_mod_record(target_root, mod_name)` - 从标记文件中删除 MOD 记录

修改现有函数：
- `_write_manifest()` - 初始化时添加 `mods: {}` 字段
- `install_mod()` - 安装后自动记录文件列表

新增主函数：
- `uninstall_mod(state)` - MOD 删除的主逻辑

#### 3. `scripts/main.py`
- 导入 `uninstall_mod` 函数
- 在"其他"菜单中新增选项 4："删除已安装的 MOD"
- 调整菜单选项编号（原来的选项 4-5 变为 5-6）

## 菜单结构

### 其他功能菜单
```
====== 其他功能 ======
1) 安装 .NET 环境
2) 检查并更新软件
3) 安装内置 MOD
4) 删除已安装的 MOD          ← 新增
5) 服务端版本管理
6) 卸载游戏
0) 返回主菜单
```

## 使用示例

### 安装 MOD
```
请选择功能：4
可用 MOD：
1. ExampleMod
2. AnotherMod
请选择要安装的 MOD（0 取消）：1
即将安装 MOD: ExampleMod，并覆盖同名文件，确认吗？ (y/N): y
[████████████████████████████] 100% (45/45)
MOD ExampleMod 安装完成。
```

### 删除 MOD
```
请选择功能：4
已安装的 MOD：
1. ExampleMod (45 个文件)
2. AnotherMod (12 个文件)
请选择要卸载的 MOD（0 取消）：1
确认卸载 MOD: ExampleMod（将删除 45 个文件）吗？ (y/N): y
MOD ExampleMod 卸载完成。
已删除 45 个文件，跳过 0 个文件。
```

## 安全特性

### 1. 精确追踪
- 每个 MOD 的文件列表单独记录
- 支持多个 MOD 共存
- 删除一个 MOD 不影响其他 MOD

### 2. 容错机制
- 文件不存在时自动跳过（不报错）
- 显示已删除/跳过的文件数量
- 删除失败时显示具体错误信息

### 3. 二次确认
- 删除前显示 MOD 名称和文件数量
- 用户必须输入 `y` 才能确认删除

### 4. 原子性操作
- 删除所有文件后再更新标记文件
- 即使部分文件删除失败，也会更新标记文件（用户可重试）

## 技术优势

| 方面 | 优势 |
|------|------|
| **精确性** | 基于压缩包内容精确记录，避免误删 |
| **多 MOD 支持** | 每个 MOD 独立记录，支持共享文件检测 |
| **可扩展性** | 为后续功能（如 MOD 依赖管理）奠定基础 |
| **用户体验** | 显示文件数量，让用户了解操作范围 |
| **容错能力** | 自动跳过不存在的文件，不中断流程 |

## 测试覆盖

已通过单元测试验证：
- ✓ MOD 文件记录功能
- ✓ 多个 MOD 共存
- ✓ MOD 记录删除
- ✓ 实际文件删除
- ✓ 标记文件结构

测试文件：`test_mod_uninstall.py`

## 后续优化建议

1. **MOD 依赖管理** - 检测 MOD 间的依赖关系
2. **MOD 启用/禁用** - 不删除文件，只改变启用状态
3. **MOD 版本管理** - 支持多版本 MOD 切换
4. **MOD 备份** - 删除前自动备份
5. **MOD 搜索** - 按名称/标签搜索 MOD

## 兼容性

- ✓ 与现有安装流程完全兼容
- ✓ 旧的标记文件自动升级（首次安装 MOD 时添加 `mods` 字段）
- ✓ 支持 Windows/Linux/macOS
